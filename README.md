# Attestat Bot (Blocks 1–2)

Telegram-бот для аттестации сотрудников клиентского сервиса. Проверяет знание линейки генетических тестов (25 вопросов) и процессных сценариев обслуживания (15 кейсов).

## Ключевые особенности

- После `/start` сотрудник вводит ФИО и должность, затем получает инструкцию по двум блокам (25+15 вопросов).
- Блок 1 «Тесты»: вопросы по биоматериалам, категориям, кодам исследований и сопоставлению данных из `tests_raw.json`. Код исследования всегда присутствует в формулировке.
- Блок 2 «Процессы»: 15 рандомных кейсов на основе файлов `Процедура обслуживания клиентов B2C (01_2024).pdf` и `_Инструкция по взаимодействию сотрудников с клиентами B2C (04_2025).docx.pdf`.
- Все ответы даются кнопками: одиночный выбор, множественный выбор, сопоставление с интерактивной клавиатурой. Текстовое поле не используется.
- После каждого ответа вопрос перерисовывается в том же сообщении; чат не засоряется.
- Итоговый отчёт содержит статистику по двум блокам, список ошибок по темам/тестам и персональный план развития.
- Все ответы логируются в хранилище результатов (по умолчанию файл `bot/storage/results.jsonl`; можно переключить на внешнюю БД).

## Настройка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

Создайте `.env` в корне и пропишите:

```
BOT_TOKEN=123:ABC
# RESULTS_BACKEND=file            # или db
# RESULTS_PATH=bot/storage/results.jsonl
# RESULT_DB_DSN=postgresql://user:pass@host:5432/dbname
# RESULT_DB_TABLE=test_results
```

## Структура

- `bot/main.py` – входная точка.
- `bot/config.py` – настройки (пути к данным, количество вопросов по блокам).
- `bot/services/`
  - `question_loader.py` – парсер выгрузки с тестами.
  - `test_question_factory.py` – генерация 25 вопросов по тестам с учётом кода, биоматериалов и категорий.
  - `process_question_factory.py` – пул кейсов по инструкциям (PDF → текст сохранён в `bot/data/process_*.txt`).
  - `question_engine.py` – сборка обоих блоков и проверка ответов.
  - `result_store.py` – адаптеры хранения (файл по умолчанию + болванка под БД).
- `bot/handlers/` – FSM и обработка всех типов клавиатур.
- `bot/data/tests_raw.json` – исходный JSON с исследованиями.
- `bot/data/process_procedure.txt`, `bot/data/process_instruction.txt` – текст из PDF для аудита.

## Запуск

```bash
python -m bot.main
```

## Хранилище результатов

Модуль `bot/services/result_store.py` содержит два адаптера:

- `FileResultStore` — текущий вариант, пишет JSONL-файл (`RESULTS_BACKEND=file`).
- `DatabaseResultStore` — заготовка для подключения Postgres/MySQL/и т. д. Пока интеграция не реализована, он автоматически пишет данные в тот же JSONL-файл (fallback), чтобы ничего не потерять.

Переключение происходит через переменные окружения:

- `RESULTS_BACKEND` — `file` (по умолчанию) или `db`.
- `RESULTS_PATH` — путь к JSONL, если выбран `file`.
- `RESULT_DB_DSN` или набор `RESULT_DB_HOST/PORT/NAME/USER/PASSWORD/TABLE` — реквизиты для IT-отдела. Пока адаптер не реализован, при выборе `db` выбрасывается `NotImplementedError`, чтобы разработчики сразу увидели, куда вставлять код.

## Дальнейшие шаги

- Подключить внешнее хранилище результатов (БД/Google Sheets).
- Добавить третьи блоки (например, кейсы по работе с жалобами).
- Ввести отчёты по группам сотрудников и автоматические напоминания о пересдаче.
