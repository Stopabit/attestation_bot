# Attestat Bot (Роли ОКС/ОП/МО)

Telegram-бот для аттестации сотрудников: общие вопросы по тестам + профильный блок для выбранной роли. Все ответы проходят через кнопки, результаты пишутся в файл/БД, по завершении формируется отчёт с ошибками и темами.

## Как проходит тест

- `/start` → бот просит ФИО, затем предлагает выбрать должность кнопкой (Менеджер ОКС, Менеджер ОП, Администратор МО, Медсестра МО).
- Блок 1 «Общие тесты»: 15 случайных вопросов из `bot/data/questions_all_tests (1).json`, в каждом вопросе указан код теста.
- Блок 2 «Профиль»: случайные вопросы по роли (`oks_questions_cleaned.json`, `otdel_prodaj.json`, `admin_questions.json`, `nurse_questions.json`):
  - ОКС — 20 вопросов
  - ОП — 20 вопросов
  - Администратор МО — 15 вопросов
  - Медсестра МО — 15 вопросов
- Типы вопросов: одиночный выбор, множественный выбор, сопоставление (matching).
- Кнопки короткие (номера), полный текст вариантов выводится в теле сообщения, чтобы ничего не обрезалось в Telegram.
- Фидбек сразу после ответа (alert), дальше автоматически показывается следующий вопрос.
- После прохождения можно листать уже отвеченные вопросы кнопками «Назад/Вперёд».
- Итоговый отчёт: общее количество верных/неверных, разбивка по блокам, список ошибок с правильными ответами и перечень тем с ошибками.

## Данные и структура

- `bot/main.py` — входная точка.
- `bot/config.py` — пути к данным, количество вопросов по блокам, настройки хранилища.
- `bot/services/` — загрузка вопросов, сборка блоков, проверка ответов, логирование результатов.
- `bot/handlers/` — FSM и клавиатуры для всех типов вопросов.
- Источники вопросов в `bot/data/`:
  - `questions_all_tests (1).json` — общие тесты (блок 1).
  - `oks_questions_cleaned.json` — Менеджер ОКС.
  - `otdel_prodaj.json` — Менеджер ОП.
  - `admin_questions.json` — Администратор МО.
  - `nurse_questions.json` — Медсестра МО.

## Настройка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

Создайте `.env` в корне и пропишите:

```
BOT_TOKEN=123:ABC
# RESULTS_BACKEND=file            # или db
# RESULTS_PATH=bot/storage/results.jsonl
# RESULT_DB_DSN=postgresql://user:pass@host:5432/dbname
# RESULT_DB_TABLE=test_results
```

## Структура

- `bot/main.py` – входная точка.
- `bot/config.py` – настройки (пути к данным, количество вопросов по блокам).
- `bot/services/`
  - `question_loader.py` – загрузка общих и профильных вопросов из JSON.
  - `question_engine.py` – сборка блоков под выбранную роль и проверка ответов.
  - `result_store.py` – адаптеры хранения (файл по умолчанию + болванка под БД).
- `bot/handlers/` – FSM и обработка всех типов клавиатур.
- `questions_all_tests (1).json`, `oks_questions_final.json`, `otdel_prodaj.json`, `admin_questions.json`, `nurse_questions.json` — входные данные для блоков (лежат в `bot/data/`).

## Запуск

```bash
python -m bot.main
```

## Хранилище результатов

Модуль `bot/services/result_store.py` содержит два адаптера:

- `FileResultStore` — текущий вариант, пишет JSONL-файл (`RESULTS_BACKEND=file`).
- `DatabaseResultStore` — заготовка для подключения Postgres/MySQL/и т. д. Пока интеграция не реализована, он автоматически пишет данные в тот же JSONL-файл (fallback), чтобы ничего не потерять.

Переключение происходит через переменные окружения:

- `RESULTS_BACKEND` — `file` (по умолчанию) или `db`.
- `RESULTS_PATH` — путь к JSONL, если выбран `file`.
- `RESULT_DB_DSN` или набор `RESULT_DB_HOST/PORT/NAME/USER/PASSWORD/TABLE` — реквизиты для IT-отдела. Пока адаптер не реализован, при выборе `db` выбрасывается `NotImplementedError`, чтобы разработчики сразу увидели, куда вставлять код.

## Обновление вопросов

- Общие тесты: редактируйте `bot/data/questions_all_tests (1).json` (структура: tests → questions с options/explanation).
- Профильные блоки: соответствующие JSON-файлы роли (см. выше). Бот фильтрует вопросы без текста или без хотя бы одного правильного ответа.
- После правок перезапустите бот.

## Дальнейшие шаги

- Подключить внешнее хранилище результатов (БД/Sheets).
- Добавить дополнительные блоки или роли.
- Ввести групповые отчёты и автоматические напоминания о пересдаче.
