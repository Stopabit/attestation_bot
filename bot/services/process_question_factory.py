from __future__ import annotations

import random
import uuid
from dataclasses import dataclass
from typing import List, Optional

from .models import Choice, Question, QuestionType


def _make_id(prefix: str) -> str:
    return f"{prefix}-{uuid.uuid4().hex[:8]}"


PROCESS_QUESTION_BANK = [
    {
        "topic": "Консультация по исследованию",
        "prompt": "Сколько времени у менеджера ОКС есть, чтобы переключить звонок на врача-консультанта в рамках консультации по исследованию?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Не более 3 минут", True),
            ("До 10 минут, если линия свободна", False),
            ("В течение рабочего дня", False),
            ("Только после завершения смены врача", False),
        ],
        "explanation": "В Таблице 1 процедуры указано: на переключение на врача-консультанта отведено 3 минуты.",
    },
    {
        "topic": "Подготовка к консультации",
        "prompt": "Из каких систем менеджер ОКС проверяет сведения перед тем, как отвечать на вопрос клиента по тесту?",
        "type": QuestionType.single_choice,
        "choices": [
            ("ERP & LIS", True),
            ("Только Google-таблица с тестами", False),
            ("Чат с коллегами", False),
            ("Календарь Outlook", False),
        ],
        "explanation": "Шаг 1.2 процедуры: проверка информации в ERP & ЛИС, чтобы подтвердить детали исследования.",
    },
    {
        "topic": "Передача врачу",
        "prompt": "Что обязан сделать менеджер ОКС, если клиенту нужна консультация врача, но переключить звонок сразу нельзя?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Сообщить, что врач перезвонит, и создать задачу врачу-консультанту в CRM", True),
            ("Попросить клиента написать на личную почту врача", False),
            ("Дать ссылку на раздел FAQ и завершить диалог", False),
            ("Перенаправить звонок любому свободному сотруднику", False),
        ],
        "explanation": "Шаг 1.6 процедуры: менеджер информирует клиента о перезвоне врача и фиксирует задачу врачу-консультанту.",
    },
    {
        "topic": "Завершение консультации врача",
        "prompt": "Что обязательно делает врач-консультант перед завершением консультации?",
        "type": QuestionType.multi_choice,
        "choices": [
            ("Уточняет, остались ли вопросы у клиента", True),
            ("Спрашивает, нужно ли записать клиента на исследование", True),
            ("Запрашивает оплату по телефону", False),
            ("Передает клиента напрямую в лабораторию", False),
        ],
        "explanation": "Шаги 2.3 и 2.5 процедуры: врач проверяет, остались ли вопросы, и уточняет необходимость записи на исследование.",
    },
    {
        "topic": "Ресепшн МО",
        "is_admin_mo": True,
        "prompt": "Как должен действовать администратор МО, если оформляет клиента, а следующий уже подошёл к стойке?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Поздороваться, попросить подождать/присесть и пообещать пригласить", True),
            ("Игнорировать до завершения текущего оформления", False),
            ("Предложить позвонить позже на колл-центр", False),
            ("Отправить клиента в лабораторию самостоятельно разбираться", False),
        ],
        "explanation": "Пункт 2.13 инструкции: администратор приветствует следующего клиента, просит подождать и информирует о приглашении.",
    },
    {
        "topic": "Поведение на ресепшн",
        "is_admin_mo": True,
        "prompt": "Выберите требования к поведению администратора в зоне ресепшн при клиентах.",
        "type": QuestionType.multi_choice,
        "choices": [
            ("Не обсуждать посторонние ситуации при пациентах", True),
            ("Не заниматься личными делами: видео, игры и т.д.", True),
            ("Можно обсуждать внутренние вопросы отдела логистики сразу при клиентах", False),
            ("Допустимо проверять личные соцсети между клиентами", False),
        ],
        "explanation": "Пункты 2.14 и раздел об общих требованиях: запрещены посторонние разговоры и личные дела при клиентах.",
    },
    {
        "topic": "Сбор анамнеза на ресепшн",
        "is_admin_mo": True,
        "prompt": "Какую информацию администратор МО обязательно уточняет у клиента при первичном обращении?",
        "type": QuestionType.multi_choice,
        "choices": [
            ("Наличие направления от врача и медицинской документации", True),
            ("Источник, откуда клиент узнал о клинике", True),
            ("Любимые фильмы клиента", False),
            ("Личный адрес врача, который направил", False),
        ],
        "explanation": "Пункт 2.16 инструкции: администратор уточняет направление, документацию и источник информации.",
    },
    {
        "topic": "Обратная связь",
        "is_admin_mo": True,
        "prompt": "Что делает администратор после завершения процедуры, если в офисе есть планшет для опросов?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Приглашает клиента пройти опрос на планшете по инструкции по сбору обратной связи", True),
            ("Просит оставить отзыв только в соцсетях", False),
            ("Сообщает, что опросы больше не проводятся", False),
            ("Переадресует к врачу для заполнения анкеты", False),
        ],
        "explanation": "Пункт 2.17 инструкции: администратор предлагает пройти опрос на планшете.",
    },
    {
        "topic": "Скрипты по ролям",
        "prompt": "Кто в обязательном порядке использует скрипты из Приложения 5 инструкции?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Врачи-консультанты", True),
            ("Только медицинские сёстры", False),
            ("Клиенты при обращении", False),
            ("Ведущий менеджер по сопровождению", False),
        ],
        "explanation": "Раздел 4 инструкции: врачи-консультанты работают по скриптам из Приложения 5.",
    },
    {
        "topic": "CRM сопровождение",
        "prompt": "Что входит в обязательные действия сотрудника при сопровождении обращения клиента в CRM?",
        "type": QuestionType.multi_choice,
        "choices": [
            ("Фиксация данных клиента и создание заказа", True),
            ("Подключение нужных специалистов (врачей, медсестер)", True),
            ("Обмен служебными сообщениями с клиентом напрямую", False),
            ("Отправка клиента в разные чаты вместо единого окна", False),
        ],
        "explanation": "Общие требования раздела 1: сотрудники фиксируют данные, создают заказ и подключают специалистов, оставляя коммуникацию в одном окне.",
    },
    {
        "topic": "Эскалация вопроса врачу",
        "prompt": "Как менеджер ОКС передает вопрос врачу-консультанту, если сам не может ответить?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Создает комментарий или задачу в комнате врачей в CRM с описанием вопроса", True),
            ("Просит клиента позвонить врачу напрямую", False),
            ("Отправляет голосовое сообщение в общий чат клиентов", False),
            ("Дает номер личного телефона врача", False),
        ],
        "explanation": "Раздел 3 инструкции: передача идет через CRM-комнату врачей с задачей или комментарием.",
    },
    {
        "topic": "Доведение до записи",
        "prompt": "Как менеджер ОКС помогает сомневающемуся клиенту принять решение о записи?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Проявляет инициативу и сразу предлагает конкретный день записи", True),
            ("Ждет, пока клиент сам напишет повторно", False),
            ("Закрывает чат без предложения", False),
            ("Переносит диалог на личные мессенджеры", False),
        ],
        "explanation": "Пункт 3.3 инструкции: менеджер предлагает выбрать дату, подчёркивая плотную запись.",
    },
    {
        "topic": "Контакты врача",
        "prompt": "Какой контакт может оставить врач-консультант клиенту?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Только корпоративную почту callcenter@genomed.ru", True),
            ("Личный адрес consult@genomed.ru", False),
            ("Номер личного мобильного", False),
            ("Телеграм врача", False),
        ],
        "explanation": "Пункт 4.5 инструкции: разрешена только корпоративная почта callcenter@genomed.ru.",
    },
    {
        "topic": "Письменные ответы врача",
        "prompt": "На какие вопросы врач-консультант готовит письменные ответы через consult@genomed.ru?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Медицинские вопросы: выбор теста, подготовка, интерпретация результатов", True),
            ("Вопросы по оплате и доставке чеков", False),
            ("Организационные жалобы на ресепшн", False),
            ("Вопросы по работе сайта", False),
        ],
        "explanation": "Пункт 4.6 инструкции: письменно отвечают на медицинские вопросы, поступившие через consult@genomed.ru.",
    },
    {
        "topic": "Педиатрический забор",
        "is_admin_mo": True,
        "prompt": "Что делает администратор МО, помогая при заборе крови у ребёнка?",
        "type": QuestionType.multi_choice,
        "choices": [
            ("Надевает перчатки согласно СОП и фиксирует локтевой сгиб", True),
            ("Отвлекает ребёнка игрушками или картинками", True),
            ("Оставляет ребёнка без внимания, пока медсестра работает", False),
            ("Просит родителей выйти из кабинета", False),
        ],
        "explanation": "Пункт 2.20 инструкции: администратор надевает перчатки, фиксирует руку и отвлекает ребёнка.",
    },
    {
        "topic": "Работа с расписанием",
        "prompt": "Что делает менеджер ОКС, если запись к врачу отменена?",
        "type": QuestionType.multi_choice,
        "choices": [
            ("Предлагает запись к другому врачу той же специализации или переносит на другое время", True),
            ("Вносит изменения в ERP/CRM и подтверждает новую дату клиенту", True),
            ("Просит клиента найти врача самостоятельно", False),
            ("Удаляет запись без уведомления клиента", False),
        ],
        "explanation": "Раздел о переносах: менеджер предлагает альтернативы и фиксирует изменения в системе.",
    },
    {
        "topic": "Обратная связь врача",
        "prompt": "Как менеджер взаимодействует с врачом после получения ответа по переданному вопросу?",
        "type": QuestionType.single_choice,
        "choices": [
            ("Возвращает обращение себе, информирует клиента и оформляет заказ", True),
            ("Просит врача лично позвонить клиенту и закрывает задачу", False),
            ("Ничего не делает, пока клиент не напомнит", False),
            ("Удаляет комментарий врача, чтобы не занимать комнату", False),
        ],
        "explanation": "Раздел 3 инструкции: после ответа врача менеджер продолжает сопровождение клиента и оформляет заказ.",
    },
]


@dataclass
class ProcessQuestionFactory:
    seed: Optional[int] = None

    def __post_init__(self) -> None:
        self.random = random.Random(self.seed)

    def generate(self, count: int) -> List[Question]:
        pool = [
            item for item in PROCESS_QUESTION_BANK if not item.get("is_admin_mo")
        ]
        self.random.shuffle(pool)
        selected = pool[:count]
        questions: List[Question] = []
        for data in selected:
            choices = [
                Choice(id=f"c{idx}", text=text, is_correct=is_correct)
                for idx, (text, is_correct) in enumerate(data["choices"])
            ]
            questions.append(
                Question(
                    id=_make_id("proc"),
                    block=2,
                    topic=data["topic"],
                    prompt=data["prompt"],
                    explanation=data["explanation"],
                    type=data["type"],
                    choices=choices,
                )
            )
        return questions
